# Feature 3 📏: The Whistle (AI Referee & Rule Dictionary)

---

## 1. Feature Definition

### 1.1 정의

'The Whistle'은 복잡한 농구 경기 상황에 대하여 국제농구연맹(FIBA) 및 미프로농구(NBA) 규정집을 근거로 명확한 판정을 내리고, 난해한 농구 용어를 정의해 주는 **AI 심판 및 규칙 백과사전** 기능이다.

### 1.2 개발 배경 및 목적

- **경기 중 분쟁 해결**: 동호인 경기에서는 심판이 없는 경우가 많아 파울이나 바이얼레이션 판정을 두고 참가자 간의 의견 충돌이 빈번하게 발생한다.
- **규칙 이해도 증진**: 농구는 규칙이 매우 방대하고 복잡하여 초보자들이 경기 흐름을 파악하기 어렵다. 이를 해결하기 위해 권위 있는 규정집에 기반한 정확한 정보를 실시간으로 제공하는 것을 목적으로 한다.

### 1.3 핵심 사용자 가치

- **공정성 (Fairness)**: 주관적인 판단이 아닌, 공식 규정집(`rules.pdf`)이라는 객관적 근거를 바탕으로 판정을 내려 경기의 공정성을 확보한다.
- **전문성 (Professionalism)**: 단순한 검색을 넘어 상황 맥락을 분석하여 판정의 근거(해당 조항)를 함께 제시함으로써 서비스의 전문성을 강화한다.
- **접근성 (Accessibility)**: 어려운 전문 용어를 누구나 이해하기 쉽게 풀이하여 제공함으로써 농구에 대한 진입 장벽을 낮춘다.

### 1.4 주요 기능 범위

1. **AI 판정 에이전트 (Judge Agent)**: 발생한 경기 상황을 텍스트로 입력하면 규정집의 벡터 데이터를 검색(RAG)하여 판정 결과와 근거 조항을 출력한다.
2. **지능형 용어 사전 (AI Glossary)**: `glossary.json` 데이터를 기반으로 전술 명칭이나 반칙 용어 등에 대한 상세한 정의를 제공한다.
3. **다중 규정 비교**: 필요한 경우 FIBA와 NBA의 규칙 차이를 비교하여 설명함으로써 사용자가 참여하는 리그 성격에 맞는 정보를 제공한다.

### 1.5 기대 효과

- **매끄러운 경기 운영**: 판정에 대한 소모적인 논쟁을 줄여 경기의 흐름을 끊지 않고 원활하게 진행할 수 있도록 돕는다.
- **룰 리터러시(Rule Literacy) 향상**: 사용자들이 정확한 규칙과 용어를 습득함으로써 보다 수준 높은 농구 경기를 즐길 수 있는 환경을 조성한다.

---

## 2. Feature Implementation Specification

### 2.1 정의

'기능 구현 설계서'란 'The Whistle' 기능이 실제 시스템에서 동작하기 위한 에이전트의 논리적 절차, 데이터 처리 방식, 그리고 규정집(PDF)과 용어 사전(JSON)의 연동 구조를 명시한 기술 문서이다.

### 2.2 에이전트 워크플로우

`LangGraph`를 통해 `JudgeAgent`를 제어하며, 비정형 데이터(PDF)와 정형 데이터(JSON)를 동시에 처리하는 복합 워크플로우를 가진다.

| 단계 | 명칭 | 설명 |
|------|------|------|
| 1 | **Input Parsing** | 사용자가 입력한 경기 상황(예: "공을 들고 세 발자국 걸으면?")을 분석하여 핵심 키워드와 질문의 의도를 파악한다. |
| 2 | **Glossary Lookup** | 입력된 문장에 포함된 특정 농구 용어를 `glossary.json`에서 검색하여 기술적 정의를 우선적으로 확보한다. |
| 3 | **RAG Retrieval** | `ChromaDB`에 임베딩된 `rules.pdf` 데이터를 대상으로 유사도 검색을 수행하여 관련 조항(Clause)을 추출한다. |
| 4 | **Judgment Synthesis** | 추출된 규정 조항과 용어 정의를 바탕으로 `GPT-4o`가 해당 상황에 대한 판정(바이얼레이션 유무 등)을 논리적으로 구성한다. |
| 5 | **Reasoning & Citing** | 최종 답변에 판정의 근거가 된 규정집의 정확한 페이지 또는 조항 번호를 명시하여 응답을 완성한다. |

### 2.3 RAG 및 문서 처리 전략

방대한 규정집을 효율적으로 탐색하기 위해 다음과 같은 기술적 전략을 적용한다.

- **PDF 파싱 및 청킹 (Chunking)**: `rules.pdf`를 단순 텍스트가 아닌 조항 단위로 분할하여 `ChromaDB`에 저장함으로써 검색의 정밀도를 높인다.
- **시맨틱 및 키워드 하이브리드 검색**: "트래블링"과 같은 명확한 용어는 키워드로, "진행 중 신체 접촉"과 같은 상황 설명은 의미론적 유사도로 검색하여 결과의 정확성을 보장한다.
- **상태 관리 (State Management)**: `LangGraph`를 활용하여 이전 대화의 맥락을 유지함으로써, 추가 질문(예: "그 상황에서 수비수가 발을 뻗었다면?")에 대해서도 연속성 있는 판정을 제공한다.

### 2.4 출력 인터페이스 규격

사용자에게 전달될 최종 판정 결과는 다음과 같은 구조를 따른다.

```json
{
  "judgment_title": "string",
  "situation_summary": "string",
  "decision": "violation | foul | legal | other",
  "reasoning": "string",
  "rule_references": [
    {
      "rule_type": "FIBA | NBA",
      "article": "string",
      "clause": "string",
      "page_number": "integer",
      "excerpt": "string"
    }
  ],
  "related_terms": [
    {
      "term": "string",
      "definition": "string"
    }
  ]
}
```

### 2.5 기술적 구성 요소

| 구성 요소 | 기술 스택 | 역할 |
|-----------|-----------|------|
| AI Engine | `LangGraph` + `GPT-4o` | 멀티 에이전트 오케스트레이션 및 판정 추론을 수행한다. |
| Vector Database | `ChromaDB` | 규정집(`rules.pdf`)의 임베딩 데이터를 관리한다. |
| Backend Framework | `FastAPI` | 비동기 엔드포인트를 통해 실시간 판정 요청을 처리한다. |
| Package Management | `uv` | 의존성 라이브러리를 관리하고 실행 환경의 일관성을 유지한다. |

---

## 3. Data Strategy

### 3.1 정의

'데이터 전략'이란 비정형 데이터인 '규정집(PDF)'과 정형 데이터인 '용어 사전(JSON)'을 유기적으로 결합하여, AI 에이전트가 복잡한 경기 상황에 대해 법적 근거가 명확한 판정을 내릴 수 있도록 지원하는 데이터 운용 체계를 의미한다.

### 3.2 데이터 구성 및 관리

정확한 규정 해석과 용어 풀이를 위해 다음과 같이 데이터 저장소를 이원화하여 관리한다.

| 구분 | 저장소 | 설명 |
|------|--------|------|
| 원천 규정 데이터 | `data/raw/rules.pdf` | FIBA 또는 NBA의 공식 경기 규정집으로, 에이전트가 판정의 근거를 추출하는 핵심 소스이다. |
| 용어 사전 데이터 | `data/raw/glossary.json` | 농구 전문 용어의 정의와 관련 개념을 담은 정형 데이터셋이다. |
| 벡터 저장소 | `ChromaDB` | 규정집의 내용을 의미 단위로 분할(Chunking)하여 저장함으로써, 자연어 상황 설명에 대한 유사도 검색을 지원한다. |

### 3.3 데이터 스키마 상세

#### 3.3.1 용어 사전 스키마 (`glossary.json`)

정확한 용어 해설을 제공하기 위해 다음과 같은 구조를 유지한다.

```json
{
  "id": "string",
  "term": "string",
  "category": "violation | foul | technique | position | other",
  "definition": "string",
  "detailed_explanation": "string",
  "related_rules": ["string"],
  "examples": ["string"],
  "tags": ["string"]
}
```

#### 3.3.2 규정집 메타데이터 구조 (`rules.pdf` 청킹 결과)

`rules.pdf`를 처리하여 `ChromaDB`에 저장할 때 다음과 같은 메타데이터를 부여한다.

```json
{
  "chunk_id": "string",
  "rule_type": "FIBA | NBA",
  "chapter": "string",
  "article": "string",
  "clause": "string",
  "page_number": "integer",
  "content": "string",
  "embedding": "vector"
}
```

### 3.4 RAG 최적화 전략

- **계층적 청킹 (Hierarchical Chunking)**: `rules.pdf`를 처리할 때 '장(Chapter) - 조(Article) - 항(Paragraph)' 단위를 유지하며 분할하여, 에이전트가 답변 시 "규정 제37조 1.1항에 의거하여..."와 같은 구체적인 인용이 가능하도록 한다.
- **메타데이터 인덱싱**: 각 벡터 데이터에 페이지 번호와 조항 제목을 메타데이터로 부여하여 검색 결과의 신뢰성을 확보한다.
- **하이브리드 검색 (Hybrid Search)**: 사용자가 입력한 구체적인 용어(키워드)와 상황 묘사(의미론적 유사도)를 동시에 검색하여 판정의 오차를 최소화한다.

### 3.5 샘플 데이터

#### Glossary Entry

| 용어 | 카테고리 | 정의 |
|------|----------|------|
| 실린더 원칙 (Cylinder Principle) | technique | 선수가 코트 위에서 차지하는 가상의 수직 공간을 의미하며, 이를 침범하여 발생하는 접촉은 반칙의 기준이 된다. |
| 트래블링 (Traveling) | violation | 볼을 소지한 상태에서 피봇 풋을 설정하지 않고 세 발자국 이상 이동하는 행위이다. |

#### Rule Excerpt

| 조항 | 내용 |
|------|------|
| Art 33. Contact: General principles | 수비 선수는 공격 선수의 실린더를 침범해서는 안 된다. |
| Art 25. Traveling | 볼을 소지한 선수가 한 발 또는 두 발을 어떤 방향으로든 규칙에 명시된 제한을 넘어 이동할 경우 트래블링이다. |

---

## 4. Wireframe

### 4.1 정의

'와이어프레임'이란 디자인적 미화를 배제하고, 화면의 골격과 기능의 배치, 정보의 위계를 선과 상자로 시각화하여 설계한 구조도를 의미한다.

### 4.2 레이아웃 구조

경기 중 긴박한 상황에서 빠르게 정보를 입력하고 결과를 확인해야 하므로, '질의응답 중심의 싱글 뷰(Single View)' 구조를 채택한다.

```
┌─────────────────────────────┐
│  Header: Assist | The Whistle │
│  [ FIBA / NBA Toggle ]      │
├─────────────────────────────┤
│                             │
│  Situation Input (Chat UI)  │
│  ─────────────────────────  │
│  💬 "공을 들고 세 발자국    │
│     걸으면 무엇인가요?"      │
│  [ 판정 요청 버튼 ]          │
│                             │
├─────────────────────────────┤
│                             │
│  Judgment Display (Core)    │
│  ─────────────────────────  │
│  🟥 트래블링 (Traveling)    │
│                             │
│  📋 판정 근거:              │
│  FIBA Art 25에 의거, 볼을   │
│  소지한 상태에서 피봇 풋    │
│  설정 없이 3발자국 이상     │
│  이동 시 바이얼레이션       │
│                             │
│  📖 [규정 조항 보기]         │
│                             │
├─────────────────────────────┤
│                             │
│  Reference Section          │
│  ─────────────────────────  │
│  🔍 관련 용어:              │
│  • 트래블링 (정의 보기)     │
│  • 피봇 풋 (정의 보기)      │
│                             │
├─────────────────────────────┤
│  🏋️ Skill Lab │ 👟 Gear │ 📏 Whistle │
└─────────────────────────────┘
```

### 4.3 주요 컴포넌트

`Shadcn/UI`의 라이브러리를 활용하여 다음과 같은 컴포넌트를 배치한다.

**판정 카드 (Judgment Card)**
- 헤더: 판정 결과(예: '오펜스 파울')를 색상 배지와 함께 표시한다.
- 본문: 규정에 근거한 상세 판정 이유를 서술한다.
- 푸터: 인용된 규정 조항(예: FIBA Art 33.1)을 버튼 형태로 배치하여 클릭 시 상세 팝업을 띄운다.

**용어 툴팁 (Term Tooltip)**
- 답변 텍스트 중 `glossary.json`에 등록된 전문 용어는 밑줄 처리를 하고, 클릭 시 풍선 도움말로 정의를 보여준다.

**규정 토글 (Rule Toggle)**
- 상단에 FIBA와 NBA 규정을 전환할 수 있는 스위치를 배치한다.

**채팅 인터페이스 (Chat Interface)**
- 사용자가 자연어로 상황을 입력할 수 있는 텍스트 입력창과 이전 질의 내역을 표시하는 대화형 UI이다.

### 4.4 사용자 흐름

```
상황 입력 → 분석 로직 가동 → 판정 확인 → 심화 학습
```

1. **상황 입력**: "수비수가 실린더를 지켰는데 공격수가 밀고 들어오면?"과 같이 상황을 입력한다.
2. **분석 로직 가동**: `JudgeAgent`가 규정집(PDF)과 용어 사전을 동시 탐색한다.
3. **판정 확인**: 화면 중앙에 나타나는 판정 결과와 근거 조항을 확인하여 동료들과 공유한다.
4. **심화 학습**: 궁금한 용어나 관련 규정을 더 읽어보며 규칙에 대한 이해도를 높인다.

### 4.5 디자인 가이드라인

- **시인성**: 판정 결과는 'Pass/Fail'의 느낌을 주도록 명확한 타이포그래피를 적용한다.
- **속도감**: 'Vibe Coding' 전략에 맞춰 복잡한 애니메이션보다는 빠른 데이터 출력에 우선순위를 둔다.
- **일관성**: 전체 프로젝트 슬로건인 "Basketball is a game of details."의 정체성을 유지하기 위해 전문적이고 신뢰감 있는 디자인을 사용한다.

---

## 5. Test Cases

### 5.1 정의

'테스트 케이스(Test Cases)'란 특정 기능이 설계된 요구사항에 따라 정확하게 동작하는지 확인하기 위해 작성된 입력값, 실행 조건, 그리고 예상 결과의 집합을 의미한다.

### 5.2 테스트 목적 및 범위

- **목적**: `JudgeAgent`가 사용자의 상황 설명을 분석하여 `rules.pdf` 및 `glossary.json`에 기반한 정확한 판정 결과와 법적 근거를 제시하는지 검증한다.
- **범위**: 규정집 데이터 검색(RAG)의 정밀도, 농구 용어 해설의 정확성, FIBA/NBA 규정 구분 능력, 그리고 사용자 인터페이스의 응답 일관성을 포함한다.

### 5.3 세부 테스트 시나리오

| ID | 시나리오 | 입력 조건 | 기대 결과 |
|----|----------|-----------|-----------|
| TC-01 | 기본 바이얼레이션 판정 | "공을 들고 세 발자국 걸으면?" | 트래블링 판정 + FIBA Art 25 인용 |
| TC-02 | 파울 판정 | "수비수가 실린더를 침범하면?" | 디펜스 파울 판정 + Art 33 인용 |
| TC-03 | 용어 사전 검색 | "실린더 원칙이 뭔가요?" | `glossary.json`에서 정의 추출 및 설명 |
| TC-04 | FIBA/NBA 규정 비교 | "FIBA와 NBA의 3점 거리 차이는?" | 두 규정의 차이를 명확히 비교 설명 |
| TC-05 | 복합 상황 판정 | "공격수가 밀고 들어가면서 슛하면?" | 오펜스 파울 + 관련 조항 다중 인용 |
| TC-06 | 예외 처리 | 모호하거나 불완전한 입력 | 추가 정보 요청 또는 가장 유사한 상황 추론 |
| TC-07 | 연속 대화 맥락 유지 | "그 상황에서 수비수가 발을 뻗으면?" | 이전 대화 맥락 유지하여 추가 판정 제공 |

### 5.4 통과 기준

1. **정확성 (Accuracy)**: AI 심판의 판정 결과가 공식 규정집(`rules.pdf`)의 내용과 논리적으로 완벽히 일치해야 한다.
2. **근거 제시 (Traceability)**: 모든 판정 결과에는 반드시 최소 하나 이상의 공식 규정 조항이 인용되어야 한다.
3. **가독성 (Readability)**: 어려운 법적 용어를 사용자가 이해하기 쉬운 평어로 풀이하여 제공해야 한다.
4. **응답 속도**: 사용자의 질의 후 판정 결과가 화면에 출력되기까지의 시간이 서비스 허용 범위 내에 있어야 한다.

### 5.5 결함 관리

테스트 과정에서 판정 오류나 근거 오인용이 발견될 경우, 'Vibe Coding' 전략에 따라 `JudgeAgent`의 RAG 검색 프롬프트를 최적화하고 `ChromaDB`의 데이터 청킹(Chunking) 단위를 재조정하여 즉시 수정한다.

---
